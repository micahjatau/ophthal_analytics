---
title: "Project 5 – EMRAM Audit Cleaning (Stages 0 to 4)"
output:
  html_document:
    toc: true
    toc_depth: 2
    number_sections: true
---


```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(tidyverse)
library(janitor)
library(readr)
library(stringr)
library(scales)
```

## 1. Load EMRAM checklist data

```{r}
emram_raw <- read_csv("data/EMRAM_Stage_0_to_4_Audit_Tool.csv") %>%
clean_names()

glimpse(emram_raw)
```


## 2. Standardize key columns
Checklist structure is one row per criterion.
We try to harmonize these columns:

stage: EMRAM stage (0 to 4)

indicator: criterion text

response: Yes or No or Partial

evidence: notes or proof

```{r}
names(emram_raw)

col_map <- list(
stage = c("stage", "emram_stage", "emram_level"),
indicator = c("indicator", "criteria", "requirement", "item", "question"),
response = c("response", "status", "implemented", "met", "yes_no"),
evidence = c("evidence", "notes", "comment", "remarks", "proof")
)

pick_col <- function(df, options) {
hit <- options[options %in% names(df)]
if (length(hit) == 0) NA_character_ else hit[1]
}

stage_col <- pick_col(emram_raw, col_map$stage)
indicator_col <- pick_col(emram_raw, col_map$indicator)
response_col <- pick_col(emram_raw, col_map$response)
evidence_col <- pick_col(emram_raw, col_map$evidence)

emram_std <- emram_raw %>%
  rename(
    stage     = emram_stage,            # EMRAM stage 0–4
    indicator = key_criteria,           # text of the criterion
    response  = hospital_status_yes_no, # Yes/No/Partial
    evidence  = notes_evidence          # notes or proof
  )

if (!is.na(evidence_col)) {
  emram_std <- emram_std %>%
    rename(evidence = all_of(evidence_col))
  } else {
    emram_std <- emram_std %>%
      mutate(evidence = NA_character_)
    }

glimpse(emram_std)
```


## 3. Clean responses to numeric scores
Iran style EMRAM checklist scoring:

Yes or Implemented = 1

Partial = 0.5

No or Absent = 0

```{r}
emram_clean <- emram_std %>%
mutate(
response_clean = str_to_lower(str_trim(as.character(response))),
response_clean = na_if(response_clean, ""),
score = case_when(
response_clean %in% c("yes", "y", "implemented", "met", "true", "1") ~ 1,
response_clean %in% c("partial", "partially", "in progress", "some") ~ 0.5,
response_clean %in% c("no", "n", "absent", "not implemented", "false", "0") ~ 0,
TRUE ~ NA_real_
)
)
```


## 4. Tag domains from indicator text

```{r}
emram_clean <- emram_clean %>%
mutate(
indicator_lc = str_to_lower(indicator),
domain = case_when(
str_detect(indicator_lc, "nurs|flowsheet|vital|clinical doc|progress note|structured") ~ "Documentation",
str_detect(indicator_lc, "cdss|decision support|alert|reminder|guideline|protocol") ~ "CDSS",
str_detect(indicator_lc, "cpoe|order entry|orders") ~ "CPOE",
str_detect(indicator_lc, "emar|medication administration|bar code|closed loop") ~ "eMAR / Med Safety",
str_detect(indicator_lc, "interop|hie|exchange|hl7|fhir|lab interface|radiology interface") ~ "Interoperability",
str_detect(indicator_lc, "audit|security|access control|privacy|backup") ~ "Security / Audit",
str_detect(indicator_lc, "governance|policy|training|change management") ~ "Governance / People",
TRUE ~ "Other"
)
)
```


## 5. Enforce constraint: CDSS absent
You stated CDSS is absent in your setting.
We force all CDSS items to score 0.

```{r}
emram_clean <- emram_clean %>%
mutate(
score = if_else(domain == "CDSS" & !is.na(score), 0, score)
)
```


## 6. Quick quality checks

```{r}
#Missing scores
missing_scores <- emram_clean %>% filter(is.na(score))

missing_scores %>%
select(stage, indicator, response, evidence) %>%
head(20)

#Stage distribution
emram_clean %>% count(stage)

#Domain distribution
emram_clean %>%
count(domain) %>%
arrange(desc(n))
```


## 7. Save cleaned checklist

```{r}
write_csv(emram_clean, "data/emram_clean.csv")
```

